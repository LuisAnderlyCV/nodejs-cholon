<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>CONTROL GALPON
    </title>
    <link rel="shortcut icon" type="image/x-icon" href="/src/views/img/icono.ico">
    <!-- Custom fonts for this admin template-->
    <link href="/src/boostrapdiseñoadmin/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for admin this template-->
    <link rel="stylesheet" href="/src/control/assets/css/fontawesome.css">
    <link rel="stylesheet" href="/src/control/assets/css/templatemo-cyborg-gaming.css">
    <link rel="stylesheet" href="/src/control/assets/css/owl.css">
    <link rel="stylesheet" href="/src/control/assets/css/animate.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
    <link href="/src/boostrapdiseñoadmin/css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('../plantilla/listamodulos') %>
            <!-- End of Sidebar -->

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <%- include('../plantilla/navbar') %>
                        <!-- End of Topbar -->
                        <div class="text-center">
                            <h1>CONTROL DE GALPON </h1>
                        </div>
                        <!-- End of Topbar -->
                        <div class="most-popular">
                            <div>
                                <form class="border rounded p-3">

                                    <h1 style="text-align: left;">Control de los pollos:</h1>
                                    <div class="row g-3">
                                        <div class="col-auto">
                                            <label class="visually-hidden">CANTIDAD DE POLLOS:</label>
                                            <input type="text" class="form-control" id="cantidad" disabled>
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">FECHA:</label>
                                            <input type="date" class="form-control" id="fecha">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">POLLOS MUERTOS:</label>
                                            <input type="text" class="form-control" id="muertos"
                                                oninput="validarNumeros(this)">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">DESCRIPCION:</label>
                                            <textarea class="form-control" aria-label="With textarea"
                                                id="discripcion"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex justify-content-end mt-2">
                                        <button type="button" onclick="regispollos()"
                                            class="btn btn-success">Registrar</button>
                                    </div>
                                </form>

                                <form class="border rounded p-3">
                                    <h1 style="text-align: left;">Control de alimento usado:</h1>
                                    <div class="row g-3">
                                        <div class="col-auto">
                                            <label class="visually-hidden">Cantidad de alimento:</label>
                                            <input type="text" class="form-control" id="alimento">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">FECHA:</label>
                                            <input type="date" class="form-control" id="fechaalimento">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">PRODUCTO:</label>
                                            <select class="form-control col-12" id="producali">
                                                <% alimentos.forEach(function(alimento) { %>
                                                    <option value="<%= alimento.idproducto %>">
                                                        <%= alimento.nombre_producto %>
                                                    </option>
                                                    <% }); %>
                                            </select>

                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">DESCRIPCION:</label>
                                            <textarea class="form-control" aria-label="With textarea"
                                                id="discripcionalimento"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex justify-content-end mt-2">
                                        <button type="button" onclick="regisalimento()"
                                            class="btn btn-success">Registrar</button>

                                    </div>
                                </form>

                                <form class="border rounded p-3">
                                    <h1 style="text-align: left;">Control de medicamentos aplicados:</h1>
                                    <div class="row g-3">
                                        <div class="col-auto">
                                            <label class="visually-hidden">Cantidad de medicamento:</label>
                                            <input type="text" class="form-control" id="medicamento">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">FECHA:</label>
                                            <input type="date" class="form-control" id="fechamedicamento">
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">PRODUCTO:</label>
                                            <select class="form-control col-12" id="producmedi">
                                                <% medicamentos.forEach(function(medicamentos) { %>
                                                    <option value="<%= medicamentos.idproducto %>">
                                                        <%= medicamentos.nombre_producto %>
                                                    </option>
                                                    <% }); %>
                                            </select>
                                        </div>
                                        <div class="col-auto">
                                            <label class="visually-hidden">DESCRIPCION:</label>
                                            <textarea class="form-control" aria-label="With textarea"
                                                id="discripcionmedicamento"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex justify-content-end mt-2">
                                        <button type="button" onclick="regismedicamento()"
                                            class="btn btn-success">Registrar</button>
                                    </div>
                                </form>



                                <!-- /.ACA GUARDAREMOS EL IDPRODUCTO Y EL IDGALPON -->
                                <input hidden type="text" class="form-control col-9" id="idgalpon">
                                <input hidden type="text" class="form-control col-9" id="idproducto">
                                <input hidden type="text" class="form-control col-9" id="filtro">
                            </div>

                        </div>

                        <div class="container-fluid overflow-auto">


                            <!-- /.container-fluid -->
                            <footer class="sticky-footer bg-white">
                                <div class="container my-auto">
                                    <div class="copyright text-center my-auto">
                                        <span>Copyright &copy; UNSM 2023</span>
                                    </div>
                                </div>
                            </footer>
                        </div>
                        <!-- End of Main Content -->

                        <!-- Footer -->

                        <!-- End of Footer -->

                </div>
                <!-- End of Content Wrapper -->

            </div>
            <!-- End of Page Wrapper -->

            <!-- Scroll to Top Button-->
            <a class="scroll-to-top rounded" href="#page-top">
                <i class="fas fa-angle-up"></i>
            </a>

            <!-- Logout Modal-->
            <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">Select "Logout" below if you are ready to end your current session.
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                            <a class="btn btn-primary" href="login.html">Logout</a>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

            <!-- Agrega esto en tu encabezado -->
            <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
                crossorigin="anonymous"></script>



            <script>

                //para validad numeros
                function validarNumeros(input) {
                    // Remueve caracteres no numéricos
                    input.value = input.value.replace(/[^0-9]/g, '');
                }

            </script>

            <!-- En tu vista -->
            <script>
                // Obten los parámetros desde el servidor y asígnalos a los elementos ocultos
                var idGalpon = '<%= idgalpon %>';
                var filtro = '<%= filtro %>';
                var idproducto = '<%- control[0].idproducto %>';
                var cantidad = '<%- control[0].cantidadpollo %>';
                var alimentglobal = JSON.parse('<%- JSON.stringify(alimentos) %>');
                var mediglobal = JSON.parse('<%- JSON.stringify(medicamentos) %>');

                // Asigna los valores a los elementos ocultos
                document.getElementById('idgalpon').value = idGalpon;
                document.getElementById('filtro').value = filtro;
                document.getElementById('idproducto').value = idproducto;
                document.getElementById('cantidad').value = cantidad;

                // Función para actualizar la cantidad en tiempo real
                function actualizarCantidadRestante() {
                    const cantidadOriginal = parseFloat(cantidad);
                    const muertos = parseFloat(document.getElementById('muertos').value);

                    if (muertos > cantidadOriginal) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'La cantidad de pollos muertos (' + muertos + ') no puede exceder la cantidad total de pollos en el galpón (' + cantidadOriginal + ')!',
                            showConfirmButton: true
                        })
                            .then(() => {
                                // Borrar el contenido del campo
                                document.getElementById('muertos').value = '';
                                // Recargar la página después de un breve retraso (por ejemplo, 500 milisegundos)
                                setTimeout(() => {
                                    location.reload();
                                }, 500);
                            });

                        // Detener la ejecución de la función
                        return;
                    }

                    const cantidadRestante = cantidadOriginal - muertos;

                    // Actualizar el valor en el input de cantidad
                    document.getElementById('cantidad').value = cantidadRestante.toFixed(2);
                }

                // Asociar la función al evento input del campo "muertos"
                document.getElementById('muertos').addEventListener('input', actualizarCantidadRestante);

                function regispollos() {
                    const cantidad = document.getElementById('cantidad').value;
                    const filtro = document.getElementById('filtro').value;
                    const idproducto = document.getElementById('idproducto').value;
                    const idgalpon = document.getElementById('idgalpon').value;
                    const fecha = document.getElementById('fecha').value;
                    const mortalidad = document.getElementById('muertos').value;
                    const descripcion = document.getElementById('discripcion').value;
                    // Validar que la fecha esté presente antes de realizar el registro
                    if (!fecha) {
                        // Mostrar un mensaje de error con SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'Por favor, ingresa una fecha antes de registrar el control de alimento.',
                            showConfirmButton: true
                        });
                        return; // Detener la ejecución si no hay fecha
                    }

                    // Crear un objeto de datos con los valores para usar en los controolers
                    const data = {
                        idgalpon: idgalpon,
                        cantidad: cantidad,
                        fecha: fecha,
                        idproducto: idproducto,
                        mortalidad: mortalidad,
                        descripcion: descripcion,
                        filtro: filtro
                    };

                    // Enviar una solicitud POST a la ruta "admin/controlgalpon" utilizando Axios
                    axios.post('/supervisor/polloscontrol', data)
                        .then(function (response) {

                            // Mostrar un mensaje de éxito con SweetAlert
                            Swal.fire({
                                icon: 'success',
                                title: 'Registro exitoso',
                                text: 'El Control Galpon Pollos se realizó correctamente.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            // Redirigir al usuario después de 2 segundos (2000 ms)
                            setTimeout(function () {
                                document.getElementById('muertos').value = "";
                                document.getElementById('fecha').value = "";
                                descripcion = document.getElementById('discripcion').value = "";
                                location.reload();
                            }, 2000);
                        })
                        .catch(function (error) {
                            console.error("Error en la operación de registro:", error);

                        });
                }

                function regisalimento() {
                    // Obtener los valores de los elementos del formulario
                    const cantidad = document.getElementById('alimento').value;
                    const filtro = document.getElementById('filtro').value;
                    const idproducto = document.getElementById('producali').value;
                    const idgalpon = document.getElementById('idgalpon').value;
                    const fecha = document.getElementById('fechaalimento').value;
                    const descripcion = document.getElementById('discripcionalimento').value;

                    console.log(alimentglobal);

                    alimentglobal.forEach(producto => {
                        console.log(`ID: ${producto.idproducto}, Código: ${producto.codigo_producto}, Nombre: ${producto.nombre_producto}`);
                    });

                    // Buscar el producto en el arreglo alimentglobal usando el idproducto
                    const productoEncontrado = alimentglobal.filter(producto => producto.idproducto == idproducto);
                    console.log(productoEncontrado[0].stock);

                    if (cantidad > productoEncontrado[0].stock) {
                        // Mostrar un mensaje de error con SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'La cantidad ingresada supera el Stok.',
                            showConfirmButton: true
                        });
                        location.reload();
                        return; // Detener la ejecución si no hay fecha
                    }

                    // Validar que la fecha esté presente antes de realizar el registro
                    if (!fecha) {
                        // Mostrar un mensaje de error con SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'Por favor, ingresa una fecha antes de registrar el control de alimento.',
                            showConfirmButton: true
                        });
                        return; // Detener la ejecución si no hay fecha
                    }

                    // Crear un objeto de datos con los valores para usar en los controladores
                    const data = {
                        idgalpon: idgalpon,
                        cantidad: cantidad,
                        fecha: fecha,
                        idproducto: idproducto,
                        descripcion: descripcion,
                        filtro: filtro
                    };

                    // Enviar una solicitud POST a la ruta "admin/controlgalpon" utilizando Axios
                    axios.post('/supervisor/alimentocontrol', data)
                        .then(function (response) {
                            // Mostrar un mensaje de éxito con SweetAlert
                            Swal.fire({
                                icon: 'success',
                                title: 'Registro exitoso',
                                text: 'El Control Galpon Pollos se realizó correctamente.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            // Limpiar los campos del formulario
                            document.getElementById('alimento').value = "";
                            document.getElementById('fechaalimento').value = "";
                            document.getElementById('discripcionalimento').value = "";
                            // Recargar la página después de 2 segundos (2000 ms)
                            setTimeout(function () {
                                location.reload();
                            }, 2000);
                        })
                        .catch(function (error) {
                            console.error("Error en la operación de registro:", error);
                        });
                }
                //funcion para validad canntidad de aliemnto en tiempo real
                // Obtener referencia al campo de alimento
                const inputAlimento = document.getElementById('alimento');

                // Agregar evento de escucha al campo de alimento
                inputAlimento.addEventListener('input', function () {
                    // Obtener el valor actual del campo de alimento
                    const cantidad = parseFloat(this.value);

                    // Obtener el valor actual del campo de producto
                    const idproducto = document.getElementById('producali').value;

                    // Buscar el producto en el arreglo alimentglobal usando el idproducto
                    const productoEncontrado = alimentglobal.find(producto => producto.idproducto == idproducto);

                    // Verificar si se encontró el producto
                    if (productoEncontrado) {
                        // Mostrar un mensaje de error si la cantidad ingresada supera el stock
                        if (cantidad > productoEncontrado.stock) {
                            // Mostrar un mensaje de error con SweetAlert
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de validación',
                                text: 'La cantidad ingresada supera el Stock.',
                                showConfirmButton: true
                            }).then(() => {
                                // Limpiar el campo de medicamento después de mostrar la notificación
                                document.getElementById('alimento').value = "";;
                            });
                        }
                    }
                });

                //------------------------------------------------------------------------
                function regismedicamento() {
                    const cantidad = document.getElementById('medicamento').value;
                    const filtro = document.getElementById('filtro').value;
                    const idproducto = document.getElementById('producmedi').value;
                    const idgalpon = document.getElementById('idgalpon').value;
                    const fecha = document.getElementById('fechamedicamento').value;
                    const descripcion = document.getElementById('discripcionmedicamento').value;

                    console.log(mediglobal);

                    mediglobal.forEach(producto => {
                        console.log(`ID: ${producto.idproducto}, Código: ${producto.codigo_producto}, Nombre: ${producto.nombre_producto}`);
                    });

                    // Buscar el producto en el arreglo alimentglobal usando el idproducto
                    console.log(idproducto);
                    const productoEncontrado = mediglobal.filter(producto => producto.idproducto == idproducto);
                    console.log(productoEncontrado[0].stock);

                    if (cantidad > productoEncontrado[0].stock) {
                        // Mostrar un mensaje de error con SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'La cantidad ingresada supera el Stok.',
                            showConfirmButton: true
                        });
                        return; // Detener la ejecución si no hay fecha
                    }


                    // Validar que la fecha esté presente antes de realizar el registro
                    if (!fecha) {
                        // Mostrar un mensaje de error con SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de validación',
                            text: 'Por favor, ingresa una fecha antes de registrar el control de alimento.',
                            showConfirmButton: true
                        });
                        return; // Detener la ejecución si no hay fecha
                    }
                    // Crear un objeto de datos con los valores para usar en los controolers
                    const data = {
                        idgalpon: idgalpon,
                        cantidad: cantidad,
                        fecha: fecha,
                        idproducto: idproducto,
                        descripcion: descripcion,
                        filtro: filtro
                    };

                    // Enviar una solicitud POST a la ruta "admin/controlgalpon" utilizando Axios
                    axios.post('/supervisor/medicamentocontrol', data)
                        .then(function (response) {

                            // Mostrar un mensaje de éxito con SweetAlert
                            Swal.fire({
                                icon: 'success',
                                title: 'Registro exitoso',
                                text: 'El Control Galpon Pollos se realizó correctamente.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                            // Redirigir al usuario después de 2 segundos (2000 ms)
                            setTimeout(function () {
                                document.getElementById('medicamento').value = "";
                                document.getElementById('fechamedicamento').value = "";
                                descripcion = document.getElementById('discripcionmedicamento').value = "";
                                location.reload();
                            }, 2000);

                        })
                        .catch(function (error) {
                            console.error("Error en la operación de registro:", error);
                        });
                }

                //validar cantidad de medicamento en tiempo real
                // Obtener referencia al campo de medicamento
                const inputMedicamento = document.getElementById('medicamento');

                // Agregar evento de escucha al campo de medicamento
                inputMedicamento.addEventListener('input', function () {
                    // Obtener el valor actual del campo de medicamento
                    const cantidad = parseFloat(this.value);

                    // Obtener el valor actual del campo de producto
                    const idproducto = document.getElementById('producmedi').value;

                    // Buscar el producto en el arreglo mediglobal usando el idproducto
                    const productoEncontrado = mediglobal.find(producto => producto.idproducto == idproducto);

                    // Verificar si se encontró el producto
                    if (productoEncontrado) {
                        // Mostrar un mensaje de error si la cantidad ingresada supera el stock
                        if (cantidad > productoEncontrado.stock) {
                            // Mostrar un mensaje de error con SweetAlert
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de validación',
                                text: 'La cantidad ingresada supera el Stock.',
                                showConfirmButton: true
                            }).then(() => {
                                // Limpiar el campo de medicamento después de mostrar la notificación
                                document.getElementById('medicamento').value = "";;
                            });
                        }
                    }
                });

            </script>


            <!-- Bootstrap core JavaScript-->
            <script src="/src/boostrapdiseñoadmin/vendor/jquery/jquery.min.js"></script>
            <script src="/src/boostrapdiseñoadmin/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

            <script src="/src/control/vendor/jquery/jquery.min.js"></script>
            <script src="/src/control/vendor/bootstrap/js/bootstrap.min.js"></script>

            <script src="/src/control/assets/js/isotope.min.js"></script>
            <script src="/src/control/assets/js/owl-carousel.js"></script>
            <script src="/src/control/assets/js/tabs.js"></script>
            <script src="/src/control/assets/js/popup.js"></script>
            <script src="/src/control/assets/js/custom.js"></script>

            <!-- Core plugin JavaScript-->
            <script src="/src/boostrapdiseñoadmin/vendor/jquery-easing/jquery.easing.min.js"></script>

            <!-- Custom scripts for admin all pages-->
            <script src="/src/boostrapdiseñoadmin/js/sb-admin-2.min.js"></script>

</body>

</html>